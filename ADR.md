# üß± ADR.md ‚Äî Architectural Decision Record

## 1Ô∏è‚É£ –ú–µ—Ç–∞
–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å –¥–ª—è –∑–±–æ—Ä—É, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –ø–æ–¥—ñ–π.

---

## 2Ô∏è‚É£ –û—Å–Ω–æ–≤–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è

### 2.1. –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ **FastAPI + PostgreSQL (async SQLAlchemy)**.
- –í–∏–±—Ä–∞–Ω–æ **Docker Compose** –¥–ª—è —ñ–∑–æ–ª—è—Ü—ñ—ó —Å–µ—Ä–≤—ñ—Å—ñ–≤ (API, Postgres, Adminer).
- –õ–æ–≥—ñ–∫–∞ –ø–æ–¥—ñ–ª–µ–Ω–∞ –Ω–∞:
  - `api/` ‚Äî REST endpoints
  - `services/` ‚Äî –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ (–æ–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
  - `db/` ‚Äî ORM-–º–æ–¥–µ–ª—ñ, –º—ñ–≥—Ä–∞—Ü—ñ—ó (Alembic)
  - `cli/` ‚Äî —ñ–º–ø–æ—Ä—Ç –ø–æ–¥—ñ–π —ñ–∑ CSV
  - `observability/` ‚Äî –ª–æ–≥–∏, –º–µ—Ç—Ä–∏–∫–∏ Prometheus
  - `tests/` ‚Äî pytest-—Ç–µ—Å—Ç–∏

---

### 2.2. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–¥—ñ–π
- –ú–æ–¥–µ–ª—å `Event`:
  ```python
  id, event_id (UUID, —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π), user_id, event_type, occurred_at, properties (JSON)
  ```
- –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–∞ **—É–Ω—ñ–∫–∞–ª—å–Ω–∏–º —ñ–Ω–¥–µ–∫—Å–æ–º –ø–æ `event_id`**.
- –î–æ–¥–∞–Ω–æ **—ñ–Ω–¥–µ–∫—Å–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ**:
  - `(event_type)`
  - `(user_id)`
  - `(occurred_at)`
- –Ü–º–ø–æ—Ä—Ç —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `INSERT ... ON CONFLICT DO NOTHING`.

---

### 2.3. –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
- `/stats/dau` ‚Äî –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–∞ –¥–∞—Ç–∞–º–∏ (`count(distinct user_id)`).
- `/stats/top-events` ‚Äî –∞–≥—Ä–µ–≥–∞—Ü—ñ—è —Ç–∏–ø—ñ–≤ –ø–æ–¥—ñ–π.
- `/stats/retention` ‚Äî –∫–æ–≥–æ—Ä—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–∞ –ø–µ—Ä—à–æ—é –ø–æ–¥—ñ—î—é.

---

### 2.4. CLI —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
- `python tools/gen_csv.py` ‚Äî —Å—Ç–≤–æ—Ä—é—î –≤–µ–ª–∏–∫—ñ CSV —ñ–∑ –≤–∏–ø–∞–¥–∫–æ–≤–∏–º–∏ –ø–æ–¥—ñ—è–º–∏.
- `python -m app.cli.import_events /data/events.csv` ‚Äî —ñ–º–ø–æ—Ä—Ç —É –±–∞–∑—É –∑ –±–∞—Ç—á–∞–º–∏ (—ñ dry-run).
- **–ü—Ä–∏—á–∏–Ω–∞:** –∑—Ä—É—á–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ –≤–µ–ª–∏–∫–∏—Ö –¥–∞–Ω–∏—Ö –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö API-–≤–∏–∫–ª–∏–∫—ñ–≤.

---

### 2.5. –°–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è
- `/metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ **Prometheus** (`http_requests_total`, `http_request_duration_seconds`).
- `/healthz` ‚Äî —Å—Ç–∞–Ω —Å–µ—Ä–≤—ñ—Å—É —Ç–∞ –ë–î.
- JSON-–ª–æ–≥–∏ —Ñ–æ—Ä–º–∞—Ç—É:
  ```json
  {"level":"info","logger":"access","msg":"access method=GET path=/healthz status=200 request_id=..."}
  ```
- **PrometheusMiddleware** –æ–±—á–∏—Å–ª—é—î –ª–∞—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏.

---

### 2.6. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ **pytest + pytest-asyncio + HTTPX**.
- –¢–µ—Å—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å:
  - —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –≤—Å—Ç–∞–≤–∫–∏ (`POST /events`);
  - –∞–Ω–∞–ª—ñ—Ç–∏–∫—É `/stats/dau`;
  - –±–∞–∑–æ–≤—É –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å retention-—Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.
- –í—Å—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑:
  ```bash
  docker compose exec -e TESTING=1 app pytest -q
  ```

---

### 2.7. –ú—ñ–≥—Ä–∞—Ü—ñ—ó
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ Alembic.
- –ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `migrations/versions`.
- –í–∏—Ä—ñ—à–µ–Ω–æ –≤—Ä—É—á–Ω—É –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —ñ–∑ –¥—É–±–ª—å–æ–≤–∞–Ω–∏–º `revision` (`db1fd24928c7` ‚Üí `a198ede84dff`).

---

# üß© –í–∏–±—ñ—Ä –±–∞–∑–∏ –¥–∞–Ω–∏—Ö: PostgreSQL

## –†—ñ—à–µ–Ω–Ω—è
–û–±—Ä–∞–Ω–æ **PostgreSQL** —è–∫ –æ—Å–Ω–æ–≤–Ω—É –°–£–ë–î –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ–¥—ñ–π.

## –ü—Ä–∏—á–∏–Ω–∏ –≤–∏–±–æ—Ä—É

### 1. –ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å —ñ –∑—Ä—ñ–ª—ñ—Å—Ç—å
PostgreSQL ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–∞ —á–∞—Å–æ–º –°–£–ë–î —ñ–∑ ACID-–≥–∞—Ä–∞–Ω—Ç—ñ—è–º–∏, —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω—ñ—Å—Ç—é —Ç–∞ –≤–∏—Å–æ–∫–æ—é 
—Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—é. –î–ª—è –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É —Ü–µ –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî –∂–æ–¥–Ω–∞ –ø–æ–¥—ñ—è –Ω–µ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –≤—Ç—Ä–∞—á–µ–Ω–∞.

### 2. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ JSONB
–ü–æ–¥—ñ—ó –º–∞—é—Ç—å –¥–∏–Ω–∞–º—ñ—á–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç–µ–π (`properties_json`). PostgreSQL –∑–∞–±–µ–∑–ø–µ—á—É—î 
–≥–Ω—É—á–∫–µ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ç–∞ —ñ–Ω–¥–µ–∫—Å–∞—Ü—ñ—é JSON —á–µ—Ä–µ–∑ —Ç–∏–ø `JSONB`. –ê —Å–∞–º–µ —Ü–µ –≤ —Ü—ñ–π –∑–∞–¥–∞—á—ñ —ñ –±—É–ª–æ
–ø–æ—Ç—Ä—ñ–±–Ω–æ.

### 3. –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ø—Ä–∏ –ø–∞–∫–µ—Ç–Ω–∏—Ö –≤—Å—Ç–∞–≤–∫–∞—Ö
PostgreSQL –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∞—Ü—é—î –∑ batch-–≤—Å—Ç–∞–≤–∫–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–æ 5000 —Ä—è–¥–∫—ñ–≤), 
–ø—ñ–¥—Ç—Ä–∏–º—É—î `COPY` —ñ –æ–ø—Ç–∏–º—ñ–∑—É—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤.

### 4. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Docker —Ç–∞ Alembic
Postgres –º–∞—î –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π –æ–±—Ä–∞–∑ Docker —ñ –¥–æ–±—Ä–µ –ø—Ä–∞—Ü—é—î –∑ ORM SQLAlchemy + Alembic. 
–¶–µ —Å–ø—Ä–æ—â—É—î —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è, CI/CD —ñ –ª–æ–∫–∞–ª—å–Ω—É —Ä–æ–∑—Ä–æ–±–∫—É.

### 5. –û—Å–Ω–æ–≤–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞
–ó –±–∞–∑ –¥–∞–Ω–∏—Ö —è –Ω–∞–π–∫—Ä–∞—â–µ –≤–æ–ª–æ–¥—ñ—é PostgreSQL

## –í–∏—Å–Ω–æ–≤–æ–∫
PostgreSQL –∑–∞–±–µ–∑–ø–µ—á—É—î —ñ–¥–µ–∞–ª—å–Ω–∏–π –±–∞–ª–∞–Ω—Å –º—ñ–∂ **–∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–º–∏ –º–æ–∂–ª–∏–≤–æ—Å—Ç—è–º–∏**, 
**–æ–ø–µ—Ä–∞—Ü—ñ–π–Ω–æ—é –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—é** —ñ **–∑—Ä—É—á–Ω—ñ—Å—Ç—é —Ä–æ–∑—Ä–æ–±–∫–∏**, —â–æ —Ä–æ–±–∏—Ç—å –π–æ–≥–æ –ø—Ä–∏—Ä–æ–¥–Ω–∏–º 
–≤–∏–±–æ—Ä–æ–º –¥–ª—è —Å–µ—Ä–≤—ñ—Å—É –∑–±–æ—Ä—É —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –ø–æ–¥—ñ–π.

---

## 3Ô∏è‚É£ –í–∏—Å–Ω–æ–≤–æ–∫
–û–±—Ä–∞–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ–∑–≤–æ–ª—è—î:
- –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–æ–±–ª—è—Ç–∏ —Å–æ—Ç–Ω—ñ —Ç–∏—Å—è—á –ø–æ–¥—ñ–π;
- –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏—Å—å –∑–∞ —Ä–∞—Ö—É–Ω–æ–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—ñ;
- –ª–µ–≥–∫–æ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—Ç–∏ —Ç–∞ –¥–µ–±–∞–∂–∏—Ç–∏ —á–µ—Ä–µ–∑ `/metrics` —ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –ª–æ–≥–∏;
- —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –Ω–æ–≤–∏–º–∏ endpoint‚Äô–∞–º–∏.
