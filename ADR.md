# üß± ADR.md ‚Äî Architectural Decision Record

## 1Ô∏è‚É£ –ú–µ—Ç–∞
–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å –¥–ª—è –∑–±–æ—Ä—É, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏ –ø–æ–¥—ñ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (**events ingestion & analytics**) —ñ–∑ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—é –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è, —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç–∞ —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è.

---

## 2Ô∏è‚É£ –û—Å–Ω–æ–≤–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è

### 2.1. –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ **FastAPI + PostgreSQL (async SQLAlchemy)**.
- –í–∏–±—Ä–∞–Ω–æ **Docker Compose** –¥–ª—è —ñ–∑–æ–ª—è—Ü—ñ—ó —Å–µ—Ä–≤—ñ—Å—ñ–≤ (API, Postgres, Adminer).
- –õ–æ–≥—ñ–∫–∞ –ø–æ–¥—ñ–ª–µ–Ω–∞ –Ω–∞:
  - `api/` ‚Äî REST endpoints
  - `services/` ‚Äî –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞ (–æ–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
  - `db/` ‚Äî ORM-–º–æ–¥–µ–ª—ñ, –º—ñ–≥—Ä–∞—Ü—ñ—ó (Alembic)
  - `cli/` ‚Äî —ñ–º–ø–æ—Ä—Ç –ø–æ–¥—ñ–π —ñ–∑ CSV
  - `observability/` ‚Äî –ª–æ–≥–∏, –º–µ—Ç—Ä–∏–∫–∏ Prometheus
  - `tests/` ‚Äî pytest-—Ç–µ—Å—Ç–∏

> **–ü—Ä–∏—á–∏–Ω–∞ –≤–∏–±–æ—Ä—É:** FastAPI –¥–∞—î –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–∏–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π —Å—Ç–µ–∫, SQLAlchemy 2.0 ‚Äî –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è–º–∏, –∞ Docker –∑–∞–±–µ–∑–ø–µ—á—É—î –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω—ñ—Å—Ç—å —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞.

---

### 2.2. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ–¥—ñ–π
- –ú–æ–¥–µ–ª—å `Event`:
  ```python
  id, event_id (UUID, —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π), user_id, event_type, occurred_at, properties (JSON)
  ```
- –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–∞ **—É–Ω—ñ–∫–∞–ª—å–Ω–∏–º —ñ–Ω–¥–µ–∫—Å–æ–º –ø–æ `event_id`**.
- –î–æ–¥–∞–Ω–æ **—ñ–Ω–¥–µ–∫—Å–∏ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ**:
  - `(event_type)`
  - `(user_id)`
  - `(occurred_at)`
- –Ü–º–ø–æ—Ä—Ç —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ `INSERT ... ON CONFLICT DO NOTHING`.

---

### 2.3. –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞
- `/stats/dau` ‚Äî –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–∞ –¥–∞—Ç–∞–º–∏ (`count(distinct user_id)`).
- `/stats/top-events` ‚Äî –∞–≥—Ä–µ–≥–∞—Ü—ñ—è —Ç–∏–ø—ñ–≤ –ø–æ–¥—ñ–π.
- `/stats/retention` ‚Äî –∫–æ–≥–æ—Ä—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑–∞ –ø–µ—Ä—à–æ—é –ø–æ–¥—ñ—î—é.

> –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ SQL-–∞–≥—Ä–µ–≥–∞—Ü—ñ—ó –Ω–∞–ø—Ä—è–º—É —á–µ—Ä–µ–∑ SQLAlchemy Core –¥–ª—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ overhead.

---

### 2.4. CLI —Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
- `python tools/gen_csv.py` ‚Äî —Å—Ç–≤–æ—Ä—é—î –≤–µ–ª–∏–∫—ñ CSV —ñ–∑ –≤–∏–ø–∞–¥–∫–æ–≤–∏–º–∏ –ø–æ–¥—ñ—è–º–∏.
- `python -m app.cli.import_events /data/events.csv` ‚Äî —ñ–º–ø–æ—Ä—Ç —É –±–∞–∑—É –∑ –±–∞—Ç—á–∞–º–∏ (—ñ dry-run).
- **–ü—Ä–∏—á–∏–Ω–∞:** –∑—Ä—É—á–Ω–æ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞ –≤–µ–ª–∏–∫–∏—Ö –¥–∞–Ω–∏—Ö –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö API-–≤–∏–∫–ª–∏–∫—ñ–≤.

---

### 2.5. –ù–∞–≥–ª—è–¥
- `/metrics` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ **Prometheus** (`http_requests_total`, `http_request_duration_seconds`).
- `/healthz` ‚Äî —Å—Ç–∞–Ω —Å–µ—Ä–≤—ñ—Å—É —Ç–∞ –ë–î.
- JSON-–ª–æ–≥–∏ —Ñ–æ—Ä–º–∞—Ç—É:
  ```json
  {"level":"info","logger":"access","msg":"access method=GET path=/healthz status=200 request_id=..."}
  ```
- **PrometheusMiddleware** –æ–±—á–∏—Å–ª—é—î –ª–∞—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å —ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏.

---

### 2.6. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ **pytest + pytest-asyncio + HTTPX**.
- –¢–µ—Å—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å:
  - —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –≤—Å—Ç–∞–≤–∫–∏ (`POST /events`);
  - –∞–Ω–∞–ª—ñ—Ç–∏–∫—É `/stats/dau`;
  - –±–∞–∑–æ–≤—É –∫–æ—Ä–µ–∫—Ç–Ω—ñ—Å—Ç—å retention-—Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É.
- –í—Å—ñ —Ç–µ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç—å –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑:
  ```bash
  docker compose exec -e TESTING=1 app pytest -q
  ```

---

### 2.7. –ú—ñ–≥—Ä–∞—Ü—ñ—ó
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ Alembic.
- –ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `migrations/versions`.
- –í–∏—Ä—ñ—à–µ–Ω–æ –≤—Ä—É—á–Ω—É –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —ñ–∑ –¥—É–±–ª—å–æ–≤–∞–Ω–∏–º `revision` (`db1fd24928c7` ‚Üí `a198ede84dff`).

---

### 2.8. –†—ñ—à–µ–Ω–Ω—è, —è–∫—ñ –±—É–ª–∏ –≤—ñ–¥—Ö–∏–ª–µ–Ω—ñ
- ‚ùå **Pandas** –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü—ñ–π ‚Äî –∑–∞–Ω–∞–¥—Ç–æ –≤–∞–∂–∫–∏–π —É –ø—Ä–æ–¥–∞–∫—à–Ω-—Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö.
- ‚ùå **ClickHouse** ‚Äî –Ω–∞–¥–ª–∏—à–∫–æ–≤–∏–π –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±—Å—è–≥—É –¥–∞–Ω–∏—Ö.
- ‚ùå **Synchronous SQLAlchemy** ‚Äî –ø–æ–≤—ñ–ª—å–Ω–æ –ø—Ä–∏ –≤–µ–ª–∏–∫–∏—Ö —ñ–º–ø–æ—Ä—Ç–∞—Ö.

---

## 3Ô∏è‚É£ –í–∏—Å–Ω–æ–≤–æ–∫
–û–±—Ä–∞–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ–∑–≤–æ–ª—è—î:
- –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–æ–±–ª—è—Ç–∏ —Å–æ—Ç–Ω—ñ —Ç–∏—Å—è—á –ø–æ–¥—ñ–π;
- –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏—Å—å –∑–∞ —Ä–∞—Ö—É–Ω–æ–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—ñ;
- –ª–µ–≥–∫–æ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—Ç–∏ —Ç–∞ –¥–µ–±–∞–∂–∏—Ç–∏ —á–µ—Ä–µ–∑ `/metrics` —ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –ª–æ–≥–∏;
- —Ä–æ–∑—à–∏—Ä—é–≤–∞—Ç–∏ –∞–Ω–∞–ª—ñ—Ç–∏–∫—É –Ω–æ–≤–∏–º–∏ endpoint‚Äô–∞–º–∏.
